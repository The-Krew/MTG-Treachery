# Treachery (MTG-Treachery) — Documentation

## Overview
- Purpose: Treachery is a multiplayer party game implemented as a React Native / Expo app. Players create or join lobbies and receive secret role cards. Gameplay occurs via a WebSocket server (wss://treachery.thekrew.app:3000/...).
- Platform: Expo / React Native (mobile-first). Uses NativeWind (Tailwind) and React Native Reanimated for animations.

## Quick Start
- Requirements: Node.js, Expo CLI / EAS if building, Android/iOS simulator or physical device.
- Install deps: `npm install` or `bun install` (project uses Bun lock but supports npm)
- Run (dev): `npm start` then open Expo on device/simulator.
- Build (EAS): `npm run build:eas` or `npm run build:local` for local builds.

## Architecture
- Entry: `app/_layout.tsx` wraps global providers and renders `WebSocketWrapper` from `app/index.tsx`.
- Router: `app/router.tsx` handles incoming WebSocket messages and selects either `LobbyScreen` or `GameScreen`.
- WebSocket layer: `app/index.tsx` manages persistent WebSocket connection, reconnect logic, heartbeat pings, and initial state sync.
- Context: `components/playerContext.tsx` exposes player state (role, card, lobby code, players list, etc.) via React Context.
- Types: `internal/types.ts` contains Request and Response shapes and `Card`/`Player` types.

## Key Screens & Components
- Lobby
  - `components/lobbyScreen.tsx`: overall lobby screen; start/leave actions.
  - `components/lobbyDetails.tsx`: create/copy/share lobby code UI and actions.
  - `components/lobbyJoin.tsx`: input + join lobby.
  - `components/lobbyPlayers.tsx`: players list and local player highlight.
- Game
  - `components/gameScreen.tsx`: main game view; shows role header, card flip, role tracker, and controls.
  - `components/gameRole.tsx`: header showing player's role (hidden/revealed animation).
  - `components/gameCard.tsx`: `FlipCard`, `FrontSide`, `BackSide` components that render and animate the card flip.
  - `components/gameRoleTracker.tsx`: shows avatars for players + revealed roles.
  - `components/gameControls.tsx`: peek/unveil/leave actions; interacts with modals and WebSocket.
- Modals / UI primitives
  - `components/interface/confirm.tsx`: confirm modal context (Accept/Cancel).
  - `components/interface/status.tsx`: info modal (messages/errors).
  - `components/interface/rarity.tsx`: modal to choose card rarity when starting a game.
  - `components/ui/button.tsx`, `components/ui/container.tsx`, `components/ui/header.tsx`: UI primitives using class-variance-authority + NativeWind.
- Connection helper
  - `components/serverConnect.tsx`: shown while connecting to server and provides a retry button.

## WebSocket Protocol
- Requests (client -> server) shaped as `Request` in `internal/types.ts`.
  - Types: `lobby`, `info`, `game`, `ping`.
  - Methods include `create`, `join`, `leave`, `info`, `start`, `stop`, `unveil`, `state`, `heartbeat`.
  - Example: { type: "lobby", method: "join", body: { code: "ABC123" } }
- Responses (server -> client) shaped as `Response`.
  - Types mirror requests: `lobby`, `info`, `game`, `pong`.
  - `body` variants: `LobbyBody`, `InfoPreParsed`, `StartGameBody`, `StopGameBody`, `UnveilBody`.

## Important Flows
- Connecting
  - `WebSocketWrapper` uses `idRef` (generated by `generateCode()` in `playerContext`) to open a WebSocket at `wss://treachery.thekrew.app:3000/<id>`.
  - After open, it requests current state (`type: info, method: state`) to sync players and game state.
  - Heartbeat: sends a `ping` every 10 seconds with `method: heartbeat`.
- Creating a Lobby
  - `LobbyDetails.handleCreateLobby()` generates a code via `generateCode()` and sends `{ type: 'lobby', method: 'create', body: { code } }`.
  - It also sends an `info` request to fetch current players for the lobby.
- Joining a Lobby
  - `LobbyJoin` sends `{ type: 'lobby', method: 'join', body: { code } }` and sets local `code` state.
- Starting a Game
  - `LobbyScreen.handleStartGame()` opens `RarityModal` and sends `{ type: 'game', method: 'start', body: { code, rarity } }`.
  - Server responds with `StartGameBody` containing `card` and `role` for the player.
- Unveiling & Peeking
  - `GameControls` handles `peek` (temporary flip) and `unveil` (permanent reveal).
  - Unveil action sends `{ type: 'game', method: 'unveil', body: { code } }`.

## State Management
- Player context props:
  - `role`, `card`, `players`, `code`, `gameState`, `unveiled`, plus setters for each.
  - `idRef` is a stable identifier used for the WebSocket path.

## Styling & Animations
- NativeWind (Tailwind) is used for styling using `className` on RN components.
- `react-native-reanimated` drives flip animations and modal/button micro-interactions.
- `class-variance-authority` (CVA) is used in `Button` and `Header` to manage style variants.

## Files Of Interest
- app/_layout.tsx — app providers and root layout
- app/index.tsx — WebSocket wrapper and connection logic
- app/router.tsx — message handling & routing between lobby/game
- internal/types.ts — protocol types and default card
- components/playerContext.tsx — React context for player state
- components/{lobby*, game*, interface/*, ui/*} — UI and features

## Dev Notes & TODOs (observations)
- `generateCode()` currently returns a tiny 2-character code: `Math.random().toString(36).substring(2, 4)` (looks like a bug — intended size is 6). Consider increasing length for uniqueness.
- `playerContext.PlayerContextType.setRole` typed as `(classIndex: string) => void` but used with role strings; types are acceptable but could be clearer.
- WebSocket URL is hard-coded to `treachery.thekrew.app:3000`; consider making it configurable via env or constants for testing.

## Testing & Running
- Use `npm start` to launch Expo dev server. Connect via Expo Go app or simulator.
- Manual testing flows: create lobby -> invite via share/copy -> join on other device -> start game -> test peek/unveil/leave.

## Next Steps I can help with
- Generate a CONTRIBUTING.md or developer quickstart with emulator setup.
- Fix minor bugs: increase lobby code length and make WebSocket URL configurable.
- Add unit / component tests for modal contexts and `playerContext`.

